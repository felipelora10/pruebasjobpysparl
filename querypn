WITH phones AS (
    SELECT
        c.ROW_ID AS ORG_ID,
        CASE 
            WHEN p.ROW_ID = c.PR_PHONE_ID 
                THEN 'P-' || TRIM(p.x_ocs_phone_num) || COALESCE('|'||TRIM(p.x_ocs_extension),'')
            ELSE TRIM(p.x_ocs_phone_num) || COALESCE('|'||TRIM(p.x_ocs_extension),'')
        END AS PHONE_FORMAT,
        TRIM(p.X_OCS_PHONE_NUM) AS PHONE_ORDER
    FROM SIEBEL.S_CON_PHONE p,
         SIEBEL.S_CONTACT   c
    WHERE c.ROW_ID = p.CON_ID
      AND p.X_OCS_END_DATE IS NULL
),

phones_agg AS (
    SELECT 
        ORG_ID,
        LISTAGG(PHONE_FORMAT, ', ')
            WITHIN GROUP (ORDER BY PHONE_ORDER) AS TELEFONOS
    FROM phones
    GROUP BY ORG_ID
),
base AS (
    SELECT 
          S_CONTACT_CLIENTE.ROW_ID                                AS ROW_ID_CLIENTE
        , TD.HIGH                                                AS TIPO_DE_DOCUMENTO_COD
        , S_CONTACT_CLIENTE.X_OCS_ID_NUM                         AS NUMERO_DE_DOCUMENTO 
        ,UPPER(SUBSTR(TRIM(REGEXP_REPLACE(NVL(S_CONTACT_CLIENTE.FST_NAME, '') || ' ' ||NVL(S_CONTACT_CLIENTE.LAST_NAME, '') || ' ' ||NVL(S_CONTACT_CLIENTE.MAIDEN_NAME, ''),'\s+', ' ')),1, 1)) ||LOWER(SUBSTR(TRIM(REGEXP_REPLACE(NVL(S_CONTACT_CLIENTE.FST_NAME, '') || ' ' ||NVL(S_CONTACT_CLIENTE.LAST_NAME, '') || ' ' ||NVL(S_CONTACT_CLIENTE.MAIDEN_NAME, ''),'\s+', ' ')),2)) AS NOMBRE_CLIENTE
        , S_ORG_EXT.LOC                                           AS COD_DIVISION_GERENTE
        --, S_ORG_EXT.NAME                                          AS DESC_DIVISION_GERENTE
        ,UPPER(SUBSTR(TRIM(REGEXP_REPLACE(NVL(S_CONTACT_EMPLEADO.FST_NAME, '') || ' ' ||NVL(S_CONTACT_EMPLEADO.LAST_NAME, '') || ' ' ||NVL(S_CONTACT_EMPLEADO.MAIDEN_NAME, ''),'\s+', ' ')),1, 1)) ||LOWER(SUBSTR(TRIM(REGEXP_REPLACE(NVL(S_CONTACT_EMPLEADO.FST_NAME, '') || ' ' ||NVL(S_CONTACT_EMPLEADO.LAST_NAME, '') || ' ' ||NVL(S_CONTACT_EMPLEADO.MAIDEN_NAME, ''),'\s+', ' ')),2)) AS NOMBRE_GERENTE
        , S_CONTACT_EMPLEADO.EMP_NUM                               AS CODIGO_SAP_GERENTE 
        , SEGMENTO.DESC_TEXT                                       AS SEGMENTO_COMERCIAL_CLIENTE
        --, SUBSEGMENTO.DESC_TEXT                                    AS SUBSEGMENTO_CLIENTE 
        , TIPO_ATENCION.DESC_TEXT                                  AS TIPO_ATENCION 
        , PER.ADDR                                                 AS DIRECCION 
        , UPPER(SUBSTR(TRIM(REGEXP_REPLACE(REGEXP_REPLACE(CIUDAD.DESC_TEXT, '\.+\s*$', ''), '\s+', ' ')),1, 1)) ||LOWER(SUBSTR(TRIM(REGEXP_REPLACE(REGEXP_REPLACE(CIUDAD.DESC_TEXT, '\.+\s*$', ''), '\s+', ' ')),2)) AS CIUDAD 
        , LIST_PROD.DESC_TEXT                                      AS CLASE_PRODUCTO 
        
		
		    lov_nid      = read_lov('OCS_NID_TYPES').select('NAME','HIGH')                     # tipo doc
    lov_segment  = read_lov('OCS_SEGMENT').select('NAME','DESC_TEXT')                  # segmento
    lov_city     = read_lov('OCS_CITY').select('VAL','DESC_TEXT')                      # ciudad
    lov_prod     = read_lov('FINCORP_PROD_ADMIN_CLASS_MLOV').select('VAL','DESC_TEXT') # clase producto
    lov_att      = read_lov('OCS_ATTENTION_TYPE').select('NAME','DESC_TEXT')           # tipo atencion
		
		
    FROM SIEBEL.S_POSTN_CON,
         SIEBEL.S_POSTN,
         SIEBEL.S_CONTACT S_CONTACT_CLIENTE,
         SIEBEL.S_CONTACT_X S_CON_X,
         SIEBEL.S_ORG_EXT,
         SIEBEL.S_CONTACT S_CONTACT_EMPLEADO,
         SIEBEL.S_EMPLOYEE_X T7,
         SIEBEL.S_ADDR_PER PER,
         SIEBEL.S_ASSET_CON RELACION,
         SIEBEL.S_ASSET PROD, 
         SIEBEL.S_PROD_INT CATALOGO_PRO, 
         SIEBEL.S_CONTACT_FNXM FNXM,
         SIEBEL.S_LST_OF_VAL CIUDAD,
         SIEBEL.S_LST_OF_VAL SEGMENTO,
		 
         SIEBEL.S_LST_OF_VAL SUBSEGMENTO,
		 
         SIEBEL.S_LST_OF_VAL TD, 
         SIEBEL.S_LST_OF_VAL LIST_PROD
         ,SIEBEL.S_LST_OF_VAL TIPO_ATENCION
		 
    WHERE S_POSTN_CON.POSTN_ID = S_POSTN.ROW_ID
      AND S_POSTN_CON.CON_ID = S_CONTACT_CLIENTE.ROW_ID
      AND S_CON_X.PAR_ROW_ID = S_CONTACT_CLIENTE.ROW_ID
      AND S_POSTN.OU_ID = S_ORG_EXT.ROW_ID
      AND S_POSTN.PR_EMP_ID = S_CONTACT_EMPLEADO.ROW_ID
      AND T7.PAR_ROW_ID = S_CONTACT_EMPLEADO.ROW_ID
      AND PER.ROW_ID = S_CONTACT_CLIENTE.PR_PER_ADDR_ID
      AND RELACION.CONTACT_ID = S_CONTACT_CLIENTE.ROW_ID
      AND RELACION.ASSET_ID = PROD.ROW_ID
      AND PROD.PROD_ID = CATALOGO_PRO.ROW_ID
      AND S_CONTACT_CLIENTE.ROW_ID = FNXM.PAR_ROW_ID 
	  and S_CONTACT_CLIENTE.PR_POSTN_ID = S_POSTN_CON.POSTN_ID 
      AND PER.CITY = CIUDAD.VAL AND CIUDAD.TYPE = 'OCS_CITY' AND CIUDAD.ACTIVE_FLG = 'Y'
      AND FNXM.ATTRIB_49 = SEGMENTO.NAME AND SEGMENTO.TYPE = 'OCS_SEGMENT' AND SEGMENTO.ACTIVE_FLG = 'Y'
	  
      AND FNXM.ATTRIB_48 = SUBSEGMENTO.NAME AND SUBSEGMENTO.TYPE = 'OCS_SUBSEGMENT' AND SUBSEGMENTO.ACTIVE_FLG = 'Y'
	  
      AND S_CONTACT_CLIENTE.X_OCS_ID_TYPE = TD.NAME AND TD.TYPE = 'OCS_NID_TYPES' AND TD.ACTIVE_FLG = 'Y'
      AND CATALOGO_PRO.DETAIL_TYPE_CD = LIST_PROD.VAL AND LIST_PROD.TYPE = 'FINCORP_PROD_ADMIN_CLASS_MLOV' AND LIST_PROD.ACTIVE_FLG = 'Y'
      AND S_CON_X.ATTRIB_39 = TIPO_ATENCION.NAME(+) AND TIPO_ATENCION.TYPE(+) = 'OCS_ATTENTION_TYPE' AND TIPO_ATENCION.ACTIVE_FLG(+) = 'Y'
      AND FNXM.ATTRIB_50 = '1000001' -- SOLO SEGMENTOS COMERCIALES
      AND S_ORG_EXT.NAME <> 'DIRECCION  ONBOARDING Y ASIGNACION'
      AND S_POSTN.NAME <> 'Siebel Administrator'
      AND PROD.STATUS_CD IN ('1010000')
      AND RELACION.RELATION_TYPE_CD IN ('Deudor','Titular principal producto')
	  AND SEGMENTO.DESC_TEXT IN ('BP - Selecto','BP - Preferente Plus','BP - Elite Plus','BP - Masivo','BP - Mi Grupo es Aval','BP - Preferente','BP - Elite')
      --AND TRUNC(S_CONTACT_CLIENTE.LAST_UPD)  >= ADD_MONTHS(SYSDATE,-3)
      
),
classes_uniq AS (
    SELECT
          ROW_ID_CLIENTE
        , TIPO_DE_DOCUMENTO_COD
        , NUMERO_DE_DOCUMENTO
        , NOMBRE_CLIENTE
        , COD_DIVISION_GERENTE
        --, DESC_DIVISION_GERENTE
        , NOMBRE_GERENTE
        , CODIGO_SAP_GERENTE
        , SEGMENTO_COMERCIAL_CLIENTE
        --, SUBSEGMENTO_CLIENTE
        , TIPO_ATENCION
        , DIRECCION
        , CIUDAD
        , CLASE_PRODUCTO
    FROM base
    GROUP BY
          ROW_ID_CLIENTE
        , TIPO_DE_DOCUMENTO_COD
        , NUMERO_DE_DOCUMENTO
        , NOMBRE_CLIENTE
        , COD_DIVISION_GERENTE
        , NOMBRE_GERENTE
        , CODIGO_SAP_GERENTE
        , SEGMENTO_COMERCIAL_CLIENTE
        , TIPO_ATENCION
        , DIRECCION
        , CIUDAD
        , CLASE_PRODUCTO
),
classes_agg_client AS (
    SELECT
          ROW_ID_CLIENTE
        , TIPO_DE_DOCUMENTO_COD
        , NUMERO_DE_DOCUMENTO
        , NOMBRE_CLIENTE
        , COD_DIVISION_GERENTE
        , NOMBRE_GERENTE
        , CODIGO_SAP_GERENTE
        , SEGMENTO_COMERCIAL_CLIENTE
        , TIPO_ATENCION
        , DIRECCION
        , CIUDAD
        , LISTAGG(CLASE_PRODUCTO, ', ')
            WITHIN GROUP (ORDER BY CLASE_PRODUCTO) AS CLASES_PRODUCTO
    FROM classes_uniq
    GROUP BY
          ROW_ID_CLIENTE
        , TIPO_DE_DOCUMENTO_COD
        , NUMERO_DE_DOCUMENTO
        , NOMBRE_CLIENTE
        , COD_DIVISION_GERENTE
        , NOMBRE_GERENTE
        , CODIGO_SAP_GERENTE
        , SEGMENTO_COMERCIAL_CLIENTE
        , TIPO_ATENCION
        , DIRECCION
        , CIUDAD
)
SELECT
      c.SEGMENTO_COMERCIAL_CLIENTE AS SEGMENTO
    , c.TIPO_DE_DOCUMENTO_COD AS "TIPO DE DOCUMENTO"
    , c.NUMERO_DE_DOCUMENTO AS IDENT
    , c.NOMBRE_CLIENTE AS "CLIENTE"
    , c.TIPO_ATENCION AS CAPA
    , c.COD_DIVISION_GERENTE AS "CODIGO ZONAL" 
    , c.CODIGO_SAP_GERENTE AS "CODIGO SAP GERENTE"
    , c.NOMBRE_GERENTE
    , c.CLASES_PRODUCTO AS "PRODUCTO"
    , p.TELEFONOS
    , c.DIRECCION
    , c.CIUDAD
FROM classes_agg_client c,
     phones_agg        p
WHERE p.ORG_ID = c.ROW_ID_CLIENTE
ORDER BY c.NOMBRE_CLIENTE;
